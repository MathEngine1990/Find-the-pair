<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ü–∞–º—è—Ç—å: –ù–∞–π–¥–∏ –ø–∞—Ä—É</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/style.css">
  
  <!-- –î–û–ë–ê–í–õ–ï–ù–û: Meta —Ç–µ–≥–∏ –¥–ª—è VK -->
  <meta property="og:title" content="–ü–∞–º—è—Ç—å: –ù–∞–π–¥–∏ –ø–∞—Ä—É" />
  <meta property="og:description" content="–¢—Ä–µ–Ω–∏—Ä—É–π—Ç–µ –ø–∞–º—è—Ç—å, –Ω–∞—Ö–æ–¥—è –ø–∞—Ä–Ω—ã–µ –∫–∞—Ä—Ç—ã!" />
  <meta property="og:image" content="https://mathengine1990.github.io/Find-the-pair/assets/icon-512.png" />
  <meta property="og:type" content="game" />
  
  <!-- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ -->
  <link rel="preload" href="lib/phaser.min.js" as="script">
  <link rel="preload" href="assets/back_card02.png" as="image">
</head>
<body>
  <div id="game"></div>

  <!-- –õ–æ–∫–∞–ª—å–Ω—ã–π Phaser (–≤–∞–∂–Ω–æ: –¥–æ —Å—Ü–µ–Ω) -->
  <script src="lib/phaser.min.js"></script>

  <!-- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ/—Ç–µ–º–∞ –∏ UI (–≤–∞–∂–Ω–æ: Button.js –¥–æ —Å—Ü–µ–Ω) -->
  <script src="ui/Theme.js"></script>
  <script src="game/Data.js"></script>
  <script src="ui/Button.js"></script>

  <!-- –î–û–ë–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Button.js —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º fallback -->
  <script>
    console.log('Checking Button.js:', typeof window.makeImageButton);
    if (typeof window.makeImageButton !== 'function') {
      console.warn('ui/Button.js –ù–ï –∑–∞–≥—Ä—É–∑–∏–ª—Å—è ‚Äî –≤–∫–ª—é—á–∞—é —É–ª—É—á—à–µ–Ω–Ω—ã–π fallback');
      
      // –£–ª—É—á—à–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –∫–Ω–æ–ø–æ–∫
      window.makeImageButton = function(scene, x, y, w, h, label, onClick, opts = {}) {
        const container = scene.add.container(x, y);
        
        // –§–æ–Ω –∫–Ω–æ–ø–∫–∏
        const bg = scene.add.graphics()
          .fillStyle(0x2C3E50)
          .fillRoundedRect(-w/2, -h/2, w, h, 8)
          .lineStyle(2, 0x3498DB, 0.8)
          .strokeRoundedRect(-w/2, -h/2, w, h, 8);
        
        // –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
        const text = scene.add.text(0, 0, label, {
          fontFamily: 'Arial, sans-serif',
          fontSize: Math.round(h * 0.25) + 'px',
          color: opts.color || '#FFFFFF',
          fontStyle: 'bold'
        }).setOrigin(0.5);
        
        // –ó–æ–Ω–∞ –∫–ª–∏–∫–∞
        const zone = scene.add.zone(0, 0, w, h)
          .setInteractive({ useHandCursor: true });
        
        container.add([bg, text, zone]);
        container.setSize(w, h);
        
        // –°–æ–±—ã—Ç–∏—è
        zone.on('pointerdown', () => onClick && onClick());
        zone.on('pointerover', () => {
          bg.clear().fillStyle(0x34495E).fillRoundedRect(-w/2, -h/2, w, h, 8)
            .lineStyle(2, 0x3498DB).strokeRoundedRect(-w/2, -h/2, w, h, 8);
          scene.tweens.add({ targets: container, scale: 1.05, duration: 100 });
        });
        zone.on('pointerout', () => {
          bg.clear().fillStyle(0x2C3E50).fillRoundedRect(-w/2, -h/2, w, h, 8)
            .lineStyle(2, 0x3498DB, 0.8).strokeRoundedRect(-w/2, -h/2, w, h, 8);
          scene.tweens.add({ targets: container, scale: 1.0, duration: 100 });
        });
        
        container.zone = zone;
        container.label = text;
        container.bg = bg;
        return container;
      };
      
      window.makeIconButton = function(scene, x, y, size, iconText, onClick, opts = {}) {
        return window.makeImageButton(scene, x, y, size, size, iconText, onClick, opts);
      };
    }
  </script>

  <!-- –°—Ü–µ–Ω—ã -->
  <script src="scenes/PreloadScene.js"></script>
  <script src="scenes/MenuScene.js"></script>
  <script src="scenes/GameScene.js"></script>

  <!-- –ò–°–ü–†–ê–í–õ–ï–ù–û: –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π VK Bridge -->
  <script src="main-vk.js"></script>
  
  <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã -->
  <script>
    // –î–û–ë–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ DOM
    function initGameWhenReady() {
      if (!window.Phaser) {
        console.error('‚ùå Phaser –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
      }

      if (!window.ALL_CARD_KEYS || !window.LEVELS) {
        console.error('‚ùå –ò–≥—Ä–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
        return;
      }

      console.log('üéÆ Initializing game...');

      const DPR = Math.min(2, window.devicePixelRatio || 1);
      const config = {
        type: Phaser.AUTO,
        parent: 'game',
        backgroundColor: '#000000',
        scale: {
          mode: Phaser.Scale.FIT,
          autoCenter: Phaser.Scale.CENTER_BOTH,
          width: 1080,
          height: 720
        },
        resolution: DPR,
        render: { 
          antialias: true, 
          pixelArt: false,
          // –î–û–ë–ê–í–õ–ï–ù–û: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
          powerPreference: 'high-performance',
          clearBeforeRender: true,
          premultipliedAlpha: true,
          preserveDrawingBuffer: false
        },
        scene: [ window.PreloadScene, window.MenuScene, window.GameScene ],
        
        // –î–û–ë–ê–í–õ–ï–ù–û: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        fps: {
          target: 60,
          forceSetTimeOut: true
        },
        
        // –î–û–ë–ê–í–õ–ï–ù–û: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        callbacks: {
          preBoot: function (game) {
            console.log('üöÄ Game pre-boot');
          },
          postBoot: function (game) {
            console.log('‚úÖ Game booted successfully');
            window.game = game;
            
            // –î–û–ë–ê–í–õ–ï–ù–û: –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫
            game.events.on('pause', () => {
              console.log('‚è∏Ô∏è Game paused');
            });
            
            game.events.on('resume', () => {
              console.log('‚ñ∂Ô∏è Game resumed');
            });
          }
        }
      };

      // –°–æ–∑–¥–∞—ë–º –∏–≥—Ä—É
      try {
        window.game = new Phaser.Game(config);
        
        // –î–û–ë–ê–í–õ–ï–ù–û: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏–≥—Ä—ã
        window.game.events.on('ready', () => {
          console.log('üéâ Game ready!');
        });
        
      } catch (error) {
        console.error('‚ùå Failed to initialize game:', error);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—à–∏–±–∫—É
        const gameDiv = document.getElementById('game');
        if (gameDiv) {
          gameDiv.innerHTML = `
            <div style="
              display: flex; 
              flex-direction: column; 
              justify-content: center; 
              align-items: center; 
              height: 100vh; 
              background: #1d2330; 
              color: #fff; 
              font-family: Arial, sans-serif;
              text-align: center;
              padding: 20px;
            ">
              <h2>üòî –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä—ã</h2>
              <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
              <button onclick="location.reload()" style="
                padding: 10px 20px; 
                font-size: 16px; 
                background: #3498db; 
                color: white; 
                border: none; 
                border-radius: 5px; 
                cursor: pointer;
                margin-top: 15px;
              ">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
          `;
        }
      }
    }

    // –î–û–ë–ê–í–õ–ï–ù–û: –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initGameWhenReady);
    } else {
      // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
      setTimeout(initGameWhenReady, 100);
    }

    // –î–û–ë–ê–í–õ–ï–ù–û: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('visibilitychange', () => {
      if (window.game) {
        if (document.hidden) {
          console.log('üì± Page hidden - pausing game');
          // –ü–∞—É–∑–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ü–µ–Ω—ã
          const activeScene = window.game.scene.getActiveScene();
          if (activeScene && activeScene.scene.key === 'GameScene') {
            activeScene.canClick = false;
            activeScene._pausedByVisibility = true;
          }
        } else {
          console.log('üì± Page visible - resuming game');
          // –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä—ã —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
          setTimeout(() => {
            const activeScene = window.game.scene.getActiveScene();
            if (activeScene && activeScene.scene.key === 'GameScene' && activeScene._pausedByVisibility) {
              activeScene.canClick = true;
              activeScene._pausedByVisibility = false;
            }
          }, 500);
        }
      }
    });

    // –î–û–ë–ê–í–õ–ï–ù–û: –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
    window.addEventListener('beforeunload', () => {
      console.log('üîÑ Page unloading - cleaning up');
      if (window.game) {
        try {
          window.game.destroy(true);
          window.game = null;
        } catch (e) {
          console.warn('Cleanup error:', e);
        }
      }
    });

    // –î–û–ë–ê–í–õ–ï–ù–û: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ JavaScript
    window.addEventListener('error', (event) => {
      console.error('üö® JavaScript Error:', event.error);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É –≤ VK –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
      if (window.VKSafe && window.VKSafe.send) {
        window.VKSafe.send('VKWebAppStorageSet', {
          key: 'last_error',
          value: JSON.stringify({
            message: event.error?.message || 'Unknown error',
            stack: event.error?.stack || 'No stack trace',
            timestamp: Date.now()
          })
        }).catch(() => {
          // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—à–∏–±–æ–∫
        });
      }
    });

    // –î–û–ë–ê–í–õ–ï–ù–û: –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ –≤ dev)
    if (window.location.hostname === 'localhost' || window.location.search.includes('debug=1')) {
      console.log('üîß Debug mode enabled');
      window.debugInfo = {
        phaser: !!window.Phaser,
        cardKeys: window.ALL_CARD_KEYS?.length || 0,
        levels: window.LEVELS?.length || 0,
        theme: !!window.THEME,
        vkBridge: !!window.vkBridge,
        userAgent: navigator.userAgent
      };
      console.table(window.debugInfo);
    }
  </script>
</body>
</html>
