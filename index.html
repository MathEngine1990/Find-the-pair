<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Память: Найди пару</title>
  <!-- КРИТИЧНО: viewport для полноэкранного режима -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, minimal-ui, viewport-fit=cover" />
    <!-- Запрет масштабирования на iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <!-- Полноэкранный режим -->
    <meta name="mobile-web-app-capable" content="yes" />

  
  <!-- ДОБАВЛЕНО: Meta теги для VK и соцсетей -->
  <meta property="og:title" content="Память: Найди пару" />
  <meta property="og:description" content="Тренируйте память, находя парные карты! Игра с системой прогресса и достижений." />
  <meta property="og:image" content="https://mathengine1990.github.io/Find-the-pair/assets/icon-512.png" />
  <meta property="og:type" content="game" />
  <meta property="og:url" content="https://mathengine1990.github.io/Find-the-pair/" />
  
  <!-- ИСПРАВЛЕНО: VK app_id должен совпадать с vk-hosting-config.json -->
  <meta name="vk:app_id" content="53937545" />
  <meta name="theme-color" content="#1d2330" />
  
  <!-- ИСПРАВЛЕНО: Убираем preload для back_card02.png чтобы избежать warning -->
  <link rel="preload" href="lib/phaser.min.js" as="script">
  <link rel="preload" href="ui/Theme.js" as="script">
  <link rel="preload" href="game/Data.js" as="script">

  <!-- ✅ Preload РЕАЛЬНЫХ шрифтов -->
<link rel="preload" href="fonts/BoldPixels.woff2" as="font" type="font/woff2" crossorigin>

    <!-- ✅ ФИХ #1: Подключение кастомного шрифта -->
  <link rel="stylesheet" href="css/fonts.css">
  
  <!-- ✅ ФИХ #2: Preload для критичной производительности -->
  <link rel="preload" 
        href="assets/fonts/BoldPixels.ttf" 
        as="font" 
        type="font/ttf" 
        crossorigin>



  <!-- Менеджер адаптивного текста -->
<script src="utils/TextManager.js"></script>
  
  <!-- ДОБАВЛЕНО: Favicon для избежания 404 ошибки -->
  <link rel="icon" type="image/png" href="assets/icon-32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="assets/icon-16.png" sizes="16x16">
</head>
<body>
  <!-- КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Добавлен fallback контент в game div -->
  <div id="game">
    <!-- Прелоадер на случай медленной загрузки -->
    <div id="preloader" style="
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
      height: 100vh; 
      background: #1d2330; 
      color: #fff; 
      font-family: Arial, sans-serif;
      text-align: center;
    ">
      <div style="
        width: 50px; 
        height: 50px; 
        border: 3px solid #4ECDC4; 
        border-top: 3px solid transparent; 
        border-radius: 50%; 
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      "></div>
      <h2 style="margin: 0 0 10px 0; color: #4ECDC4;">Find the Pair</h2>
      <p style="margin: 0; color: #ccc;">Загрузка игры...</p>
    </div>
  </div>

  <!-- ДОБАВЛЕНО: CSS для анимации прелоадера и стилей -->
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @font-face {
  font-family: 'YourFont';
  src: url('fonts/YourFont-Regular.woff2') format('woff2');
  font-weight: normal;
  font-style: normal;
  font-display: block; /* ← ВАЖНО: блокирует рендер до загрузки */
}
    
    /* Скрываем прелоадер когда игра загружена */
    .game-loaded #preloader {
      display: none !important;
    }
    
    /* Убеждаемся что game div занимает весь экран */
    #game {
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
      overflow: hidden;
    }
    
    /* Дополнительные стили для стабильности */
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #1d2330;
    }
    
    html {
      height: 100%;
      overflow: hidden;
    }
  </style>

  <!-- Локальный Phaser (важно: до сцен) -->
  <script src="lib/phaser.min.js"></script>

  <!-- Глобальные данные/тема и UI (важно: Button.js до сцен) -->
  <script src="ui/Theme.js"></script>
  <script src="game/Data.js"></script>
  <script src="ui/Button.js"></script>

  <script src="sync/ProgressSyncManager.js"></script>

  <!-- УЛУЧШЕНО: Расширенная заглушка для Button.js с проверками зависимостей -->
  <script>
    console.log('Buttons loaded?', typeof window.makeImageButton);
    
    // ИСПРАВЛЕНИЕ: Проверяем загрузку зависимостей
    function checkDependencies() {
      const deps = {
        Phaser: typeof window.Phaser !== 'undefined',
        THEME: typeof window.THEME !== 'undefined',
        ALL_CARD_KEYS: Array.isArray(window.ALL_CARD_KEYS),
        LEVELS: Array.isArray(window.LEVELS),
        makeImageButton: typeof window.makeImageButton === 'function'
      };
      
      console.log('Dependencies check:', deps);
      
      const allLoaded = Object.values(deps).every(Boolean);
      if (allLoaded) {
        console.log('✅ All dependencies loaded');
        document.body.classList.add('dependencies-ready');
      } else {
        console.warn('⚠️ Some dependencies missing:', 
          Object.entries(deps).filter(([key, value]) => !value).map(([key]) => key)
        );
      }
      
      return allLoaded;
    }
    
    if (typeof window.makeImageButton !== 'function') {
      console.warn('ui/Button.js НЕ загрузился — включаю улучшенную заглушку');
      
      // Улучшенная заглушка с анимациями и стилями
      window.makeImageButton = function(scene, x, y, w, h, label, onClick, opts = {}) {
        const container = scene.add.container(x, y);
        
        // Фон кнопки с градиентом
        const bg = scene.add.graphics()
          .fillGradientStyle(0x2C3E50, 0x2C3E50, 0x34495E, 0x34495E)
          .fillRoundedRect(-w/2, -h/2, w, h, 8)
          .lineStyle(2, 0x3498DB, 0.8)
          .strokeRoundedRect(-w/2, -h/2, w, h, 8);
        
        // Текст кнопки с тенью
        const text = scene.add.text(0, 0, label, {
          fontFamily: window.THEME?.fontButton || 'Arial, sans-serif',
          fontSize: Math.round(h * (window.THEME?.btnFontFactor || 0.25)) + 'px',
          color: opts.color || window.THEME?.buttonTextColor || '#FFFFFF',
          fontStyle: window.THEME?.buttonStyle || 'bold'
        }).setOrigin(0.5);
        
        // Тень для текста
        text.setShadow(0, 2, '#000000', 4, false, true);
        
        // Зона клика
        const zone = scene.add.zone(0, 0, w, h)
          .setInteractive({ useHandCursor: true });
        
        container.add([bg, text, zone]);
        container.setSize(w, h);
        
        // УЛУЧШЕНО: События с анимациями
        zone.on('pointerdown', () => {
          if (onClick) {
            // Анимация нажатия
            scene.tweens.add({
              targets: container,
              scale: 0.95,
              duration: 100,
              yoyo: true,
              ease: 'Power2'
            });
            onClick();
          }
        });
        
        zone.on('pointerover', () => {
          // Изменение фона при наведении
          bg.clear()
            .fillGradientStyle(0x34495E, 0x34495E, 0x3C5A78, 0x3C5A78)
            .fillRoundedRect(-w/2, -h/2, w, h, 8)
            .lineStyle(2, 0x52A7F7)
            .strokeRoundedRect(-w/2, -h/2, w, h, 8);
          
          // Анимация масштаба
          scene.tweens.add({ 
            targets: container, 
            scale: 1.05, 
            duration: 150,
            ease: 'Power2'
          });
        });
        
        zone.on('pointerout', () => {
          // Возврат к исходному виду
          bg.clear()
            .fillGradientStyle(0x2C3E50, 0x2C3E50, 0x34495E, 0x34495E)
            .fillRoundedRect(-w/2, -h/2, w, h, 8)
            .lineStyle(2, 0x3498DB, 0.8)
            .strokeRoundedRect(-w/2, -h/2, w, h, 8);
          
          scene.tweens.add({ 
            targets: container, 
            scale: 1.0, 
            duration: 150,
            ease: 'Power2'
          });
        });
        
        // Свойства для совместимости
        container.zone = zone;
        container.label = text;
        container.bg = bg;
        return container;
      };
      
      window.makeIconButton = function(scene, x, y, size, iconText, onClick, opts = {}) {
        const container = scene.add.container(x, y);
        
        // Круглый фон
        const bg = scene.add.graphics()
          .fillStyle(0x2C3E50, 0.8)
          .fillCircle(0, 0, size/2)
          .lineStyle(2, 0x3498DB, 0.6)
          .strokeCircle(0, 0, size/2);
        
        // Иконка
        const icon = scene.add.text(0, 0, iconText, {
          fontFamily: window.THEME?.fontButton || 'Arial, sans-serif',
          fontSize: Math.round(size * (opts.fontFactor || 0.4)) + 'px',
          color: opts.color || window.THEME?.buttonTextColor || '#FFFFFF',
          fontStyle: window.THEME?.buttonStyle || 'bold'
        }).setOrigin(0.5);
        
        // Зона клика
        const zone = scene.add.zone(0, 0, size, size)
          .setInteractive({ useHandCursor: true });
        
        container.add([bg, icon, zone]);
        container.setSize(size, size);
        
        // События с анимациями
        zone.on('pointerdown', () => {
          if (onClick) {
            scene.tweens.add({
              targets: container,
              scale: 0.9,
              duration: 100,
              yoyo: true,
              ease: 'Power2'
            });
            onClick();
          }
        });
        
        zone.on('pointerover', () => {
          bg.clear()
            .fillStyle(0x34495E, 0.9)
            .fillCircle(0, 0, size/2)
            .lineStyle(2, 0x52A7F7)
            .strokeCircle(0, 0, size/2);
          
          scene.tweens.add({ targets: container, scale: 1.1, duration: 150 });
        });
        
        zone.on('pointerout', () => {
          bg.clear()
            .fillStyle(0x2C3E50, 0.8)
            .fillCircle(0, 0, size/2)
            .lineStyle(2, 0x3498DB, 0.6)
            .strokeCircle(0, 0, size/2);
          
          scene.tweens.add({ targets: container, scale: 1.0, duration: 150 });
        });
        
        container.zone = zone;
        container.label = icon;
        container.bg = bg;
        return container;
      };
    }
    
    // Проверяем зависимости после загрузки каждого скрипта
    setTimeout(checkDependencies, 50);
  </script>

  <!-- Сцены -->
  <script src="scenes/PreloadScene.js"></script>
  <script src="scenes/MenuScene.js"></script>
  <script src="scenes/GameScene.js"></script>

  <!-- ✅ gameConfig перенесён в main.js (единственный источник правды) -->
  <script src="utils/ResponsiveManager.js"></script>

  <!-- ИСПРАВЛЕНО: main.js загружается последним с обработкой ошибок -->
  <script src="main.js"></script>
  
  <!-- ДОБАВЛЕНО: Финальные обработчики событий -->
  <script>
    // Обработка поворота экрана
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        if (window.game && window.game.scale) {
          window.game.scale.refresh();
          console.log('🔄 Screen orientation changed, game refreshed');
        }
      }, 500);
    });
    
    // Обработка изменения размера окна
    window.addEventListener('resize', () => {
      if (window.game && window.game.scale) {
        clearTimeout(window.resizeTimeout);
        window.resizeTimeout = setTimeout(() => {
          window.game.scale.refresh();
          console.log('🔄 Window resized, game refreshed');
        }, 250);
      }
    });
    
    // ДОБАВЛЕНО: Очистка при выходе со страницы
    window.addEventListener('beforeunload', () => {
      console.log('🔄 Page unloading, cleaning up...');
      if (window.game) {
        try {
          window.game.destroy(true);
          window.game = null;
        } catch (e) {
          console.warn('Cleanup warning:', e);
        }
      }
    });

    // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Финальная проверка инициализации
    window.addEventListener('load', () => {
      console.log('📄 Page fully loaded');
      
      // Проверяем что игра успешно создалась
      setTimeout(() => {
        if (!window.game) {
          console.warn('⚠️ Game not created after page load - showing error');
          const gameDiv = document.getElementById('game');
          if (gameDiv) {
            gameDiv.innerHTML = `
              <div style="
                display: flex; 
                flex-direction: column; 
                justify-content: center; 
                align-items: center; 
                height: 100vh; 
                background: #1d2330; 
                color: #fff; 
                font-family: Arial, sans-serif;
                text-align: center;
                padding: 20px;
              ">
                <h2>⚠️ Игра не загрузилась</h2>
                <p>Попробуйте обновить страницу или проверьте интернет-соединение</p>
                <button onclick="location.reload()" style="
                  padding: 12px 24px; 
                  font-size: 16px; 
                  background: #e74c3c; 
                  color: white; 
                  border: none; 
                  border-radius: 8px; 
                  cursor: pointer;
                  margin-top: 20px;
                  font-weight: bold;
                ">🔄 Перезагрузить</button>
              </div>
            `;
          }
        }
      }, 3000);
    });
  </script>


</body>
</html>
