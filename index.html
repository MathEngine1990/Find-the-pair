<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Память: Найди пару</title>
  <!-- КРИТИЧНО: viewport для полноэкранного режима -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, minimal-ui, viewport-fit=cover" />
    <!-- Запрет масштабирования на iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <!-- Полноэкранный режим -->
    <meta name="mobile-web-app-capable" content="yes" />

  
  <!-- ДОБАВЛЕНО: Meta теги для VK и соцсетей -->
  <meta property="og:title" content="Память: Найди пару" />
  <meta property="og:description" content="Тренируйте память, находя парные карты! Игра с системой прогресса и достижений." />
  <meta property="og:image" content="https://mathengine1990.github.io/Find-the-pair/assets/icon-512.png" />
  <meta property="og:type" content="game" />
  <meta property="og:url" content="https://mathengine1990.github.io/Find-the-pair/" />
  
  <!-- ИСПРАВЛЕНО: VK app_id должен совпадать с vk-hosting-config.json -->
  <meta name="vk:app_id" content="53937545" />
  <meta name="theme-color" content="#1d2330" />
  
  <!-- ИСПРАВЛЕНО: Убираем preload для back_card02.png чтобы избежать warning -->
  <link rel="preload" href="lib/phaser.min.js" as="script">
  <link rel="preload" href="ui/Theme.js" as="script">
  <link rel="preload" href="game/Data.js" as="script">
  
  <!-- ДОБАВЛЕНО: Favicon для избежания 404 ошибки -->
  <link rel="icon" type="image/png" href="assets/icon-32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="assets/icon-16.png" sizes="16x16">
</head>
<body>
  <!-- КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Добавлен fallback контент в game div -->
  <div id="game">
    <!-- Прелоадер на случай медленной загрузки -->
    <div id="preloader" style="
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
      height: 100vh; 
      background: #1d2330; 
      color: #fff; 
      font-family: Arial, sans-serif;
      text-align: center;
    ">
      <div style="
        width: 50px; 
        height: 50px; 
        border: 3px solid #4ECDC4; 
        border-top: 3px solid transparent; 
        border-radius: 50%; 
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      "></div>
      <h2 style="margin: 0 0 10px 0; color: #4ECDC4;">Find the Pair</h2>
      <p style="margin: 0; color: #ccc;">Загрузка игры...</p>
    </div>
  </div>

  <!-- ДОБАВЛЕНО: CSS для анимации прелоадера и стилей -->
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Скрываем прелоадер когда игра загружена */
    .game-loaded #preloader {
      display: none !important;
    }
    
    /* Убеждаемся что game div занимает весь экран */
    #game {
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
      overflow: hidden;
    }
    
    /* Дополнительные стили для стабильности */
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #1d2330;
    }
    
    html {
      height: 100%;
      overflow: hidden;
    }
  </style>

  <!-- Локальный Phaser (важно: до сцен) -->
  <script src="lib/phaser.min.js"></script>

  <!-- Глобальные данные/тема и UI (важно: Button.js до сцен) -->
  <script src="ui/Theme.js"></script>
  <script src="game/Data.js"></script>
  <script src="ui/Button.js"></script>

  <script src="sync/ProgressSyncManager.js"></script>

  <!-- УЛУЧШЕНО: Расширенная заглушка для Button.js с проверками зависимостей -->
  <script>
    console.log('Buttons loaded?', typeof window.makeImageButton);
    
    // ИСПРАВЛЕНИЕ: Проверяем загрузку зависимостей
    function checkDependencies() {
      const deps = {
        Phaser: typeof window.Phaser !== 'undefined',
        THEME: typeof window.THEME !== 'undefined',
        ALL_CARD_KEYS: Array.isArray(window.ALL_CARD_KEYS),
        LEVELS: Array.isArray(window.LEVELS),
        makeImageButton: typeof window.makeImageButton === 'function'
      };
      
      console.log('Dependencies check:', deps);
      
      const allLoaded = Object.values(deps).every(Boolean);
      if (allLoaded) {
        console.log('✅ All dependencies loaded');
        document.body.classList.add('dependencies-ready');
      } else {
        console.warn('⚠️ Some dependencies missing:', 
          Object.entries(deps).filter(([key, value]) => !value).map(([key]) => key)
        );
      }
      
      return allLoaded;
    }
    
    if (typeof window.makeImageButton !== 'function') {
      console.warn('ui/Button.js НЕ загрузился — включаю улучшенную заглушку');
      
      // Улучшенная заглушка с анимациями и стилями
      window.makeImageButton = function(scene, x, y, w, h, label, onClick, opts = {}) {
        const container = scene.add.container(x, y);
        
        // Фон кнопки с градиентом
        const bg = scene.add.graphics()
          .fillGradientStyle(0x2C3E50, 0x2C3E50, 0x34495E, 0x34495E)
          .fillRoundedRect(-w/2, -h/2, w, h, 8)
          .lineStyle(2, 0x3498DB, 0.8)
          .strokeRoundedRect(-w/2, -h/2, w, h, 8);
        
        // Текст кнопки с тенью
        const text = scene.add.text(0, 0, label, {
          fontFamily: window.THEME?.fontButton || 'Arial, sans-serif',
          fontSize: Math.round(h * (window.THEME?.btnFontFactor || 0.25)) + 'px',
          color: opts.color || window.THEME?.buttonTextColor || '#FFFFFF',
          fontStyle: window.THEME?.buttonStyle || 'bold'
        }).setOrigin(0.5);
        
        // Тень для текста
        text.setShadow(0, 2, '#000000', 4, false, true);
        
        // Зона клика
        const zone = scene.add.zone(0, 0, w, h)
          .setInteractive({ useHandCursor: true });
        
        container.add([bg, text, zone]);
        container.setSize(w, h);
        
        // УЛУЧШЕНО: События с анимациями
        zone.on('pointerdown', () => {
          if (onClick) {
            // Анимация нажатия
            scene.tweens.add({
              targets: container,
              scale: 0.95,
              duration: 100,
              yoyo: true,
              ease: 'Power2'
            });
            onClick();
          }
        });
        
        zone.on('pointerover', () => {
          // Изменение фона при наведении
          bg.clear()
            .fillGradientStyle(0x34495E, 0x34495E, 0x3C5A78, 0x3C5A78)
            .fillRoundedRect(-w/2, -h/2, w, h, 8)
            .lineStyle(2, 0x52A7F7)
            .strokeRoundedRect(-w/2, -h/2, w, h, 8);
          
          // Анимация масштаба
          scene.tweens.add({ 
            targets: container, 
            scale: 1.05, 
            duration: 150,
            ease: 'Power2'
          });
        });
        
        zone.on('pointerout', () => {
          // Возврат к исходному виду
          bg.clear()
            .fillGradientStyle(0x2C3E50, 0x2C3E50, 0x34495E, 0x34495E)
            .fillRoundedRect(-w/2, -h/2, w, h, 8)
            .lineStyle(2, 0x3498DB, 0.8)
            .strokeRoundedRect(-w/2, -h/2, w, h, 8);
          
          scene.tweens.add({ 
            targets: container, 
            scale: 1.0, 
            duration: 150,
            ease: 'Power2'
          });
        });
        
        // Свойства для совместимости
        container.zone = zone;
        container.label = text;
        container.bg = bg;
        return container;
      };
      
      window.makeIconButton = function(scene, x, y, size, iconText, onClick, opts = {}) {
        const container = scene.add.container(x, y);
        
        // Круглый фон
        const bg = scene.add.graphics()
          .fillStyle(0x2C3E50, 0.8)
          .fillCircle(0, 0, size/2)
          .lineStyle(2, 0x3498DB, 0.6)
          .strokeCircle(0, 0, size/2);
        
        // Иконка
        const icon = scene.add.text(0, 0, iconText, {
          fontFamily: window.THEME?.fontButton || 'Arial, sans-serif',
          fontSize: Math.round(size * (opts.fontFactor || 0.4)) + 'px',
          color: opts.color || window.THEME?.buttonTextColor || '#FFFFFF',
          fontStyle: window.THEME?.buttonStyle || 'bold'
        }).setOrigin(0.5);
        
        // Зона клика
        const zone = scene.add.zone(0, 0, size, size)
          .setInteractive({ useHandCursor: true });
        
        container.add([bg, icon, zone]);
        container.setSize(size, size);
        
        // События с анимациями
        zone.on('pointerdown', () => {
          if (onClick) {
            scene.tweens.add({
              targets: container,
              scale: 0.9,
              duration: 100,
              yoyo: true,
              ease: 'Power2'
            });
            onClick();
          }
        });
        
        zone.on('pointerover', () => {
          bg.clear()
            .fillStyle(0x34495E, 0.9)
            .fillCircle(0, 0, size/2)
            .lineStyle(2, 0x52A7F7)
            .strokeCircle(0, 0, size/2);
          
          scene.tweens.add({ targets: container, scale: 1.1, duration: 150 });
        });
        
        zone.on('pointerout', () => {
          bg.clear()
            .fillStyle(0x2C3E50, 0.8)
            .fillCircle(0, 0, size/2)
            .lineStyle(2, 0x3498DB, 0.6)
            .strokeCircle(0, 0, size/2);
          
          scene.tweens.add({ targets: container, scale: 1.0, duration: 150 });
        });
        
        container.zone = zone;
        container.label = icon;
        container.bg = bg;
        return container;
      };
    }
    
    // Проверяем зависимости после загрузки каждого скрипта
    setTimeout(checkDependencies, 50);
  </script>

  <!-- Сцены -->
  <script src="scenes/PreloadScene.js"></script>
  <script src="scenes/MenuScene.js"></script>
  <script src="scenes/GameScene.js"></script>

  <!-- СОХРАНЕНО: Ваши настройки сверхвысокого разрешения + критические исправления -->
  <script>
    // ДОБАВЛЕНО: Проверка готовности всех зависимостей
    function checkAllDependencies() {
      const required = [
        { name: 'Phaser', check: () => window.Phaser },
        { name: 'THEME', check: () => window.THEME },
        { name: 'ALL_CARD_KEYS', check: () => window.ALL_CARD_KEYS },
        { name: 'LEVELS', check: () => window.LEVELS },
        { name: 'PreloadScene', check: () => window.PreloadScene },
        { name: 'MenuScene', check: () => window.MenuScene },
        { name: 'GameScene', check: () => window.GameScene }
      ];
      
      const missing = required.filter(dep => !dep.check());
      
      if (missing.length > 0) {
        console.error('❌ Missing dependencies:', missing.map(d => d.name));
        return false;
      }
      
      console.log('✅ All dependencies loaded');
      return true;
    }

    // Максимальный DPR для ультра-четкости (СОХРАНЕНО из вашего кода)
    const DPR = window.devicePixelRatio || 1;
    

    
    // ИСПРАВЛЕНИЕ: Используем локальную проверку
const detectMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
const isLowEnd = navigator.hardwareConcurrency <= 2 || navigator.deviceMemory <= 2;

let baseWidth, baseHeight;

if (detectMobile && isLowEnd) {
  baseWidth = 1080;
  baseHeight = 720;
  console.log('📱 Low-end mobile detected, using standard resolution');
} else if (detectMobile) {
  baseWidth = 1920;
  baseHeight = 1080;
  console.log('📱 Mobile detected, using high resolution');
} else {
  baseWidth = 1920;
  baseHeight = 1080;
  console.log('🖥️ Desktop detected, using ultra-high resolution');
}
    
    window.gameConfig = {
      type: Phaser.AUTO,
      parent: 'game',
      backgroundColor: '#1d2330',
      scale: {
        // FIT режим для лучшего качества (СОХРАНЕНО)
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH,
        // Адаптивное разрешение с вашими значениями для десктопа
        width: baseWidth,
        height: baseHeight
      },
      resolution: DPR,
      render: { 
        antialias: true, 
        pixelArt: false,
        roundPixels: false, // Максимальная четкость (СОХРАНЕНО)
        powerPreference: 'high-performance',
        // СОХРАНЕНО: Ваши дополнительные настройки качества
        premultipliedAlpha: true,
        transparent: false,
        clearBeforeRender: true,
        // ДОБАВЛЕНО: Дополнительные оптимизации
        batchSize: 4096,
        maxTextures: 16
      },
      scene: [ window.PreloadScene, window.MenuScene, window.GameScene ],
      physics: {
        default: false // СОХРАНЕНО: Отключена физика
      },
      input: {
        activePointers: 1,
        smoothFactor: 0.1 // СОХРАНЕНО: Сглаживание для плавности
      },
      // ДОБАВЛЕНО: Настройки производительности
      fps: {
        target: 60,
        forceSetTimeOut: true,
        deltaHistory: 10
      },
      // ДОБАВЛЕНО: Обработчики для интеграции с VK
      callbacks: {
        preBoot: function(game) {
          console.log('🚀 Game pre-boot');
          
          // Проверяем зависимости
          if (!checkAllDependencies()) {
            throw new Error('Missing required dependencies');
          }
        },
        
        postBoot: function(game) {
          console.log('✅ Game booted successfully', {
            renderer: game.renderer.type === 0 ? 'Canvas' : 'WebGL',
            resolution: DPR,
            size: `${game.scale.width}x${game.scale.height}`,
            deviceRatio: window.devicePixelRatio,
            mobile: detectMobile,
            lowEnd: isLowEnd
          });
          
          // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Убираем прелоадер после успешной инициализации
          hidePreloader();
          
          // Сохраняем ссылку на игру глобально
          window.game = game;
          
          // ДОБАВЛЕНО: Передача VK данных в игру
          if (window.VK_USER_DATA) {
            game.registry.set('vkUserData', window.VK_USER_DATA);
          }
          if (window.VK_LAUNCH_PARAMS) {
            game.registry.set('vkLaunchParams', window.VK_LAUNCH_PARAMS);
          }
          
          // Глобальные обработчики ошибок
          game.events.on('pause', () => console.log('⏸️ Game paused'));
          game.events.on('resume', () => console.log('▶️ Game resumed'));
          
          // ДОБАВЛЕНО: Отладочная информация
          if (window.location.search.includes('debug=1')) {
            console.log('🔧 Debug mode enabled');
            window.debugGameConfig = {
              config: game.config,
              renderer: game.renderer,
              textures: game.textures,
              scale: game.scale
            };
          }
        }
      }
    };

    // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Функция скрытия прелоадера
    function hidePreloader() {
      const preloader = document.getElementById('preloader');
      if (preloader) {
        preloader.style.display = 'none';
        document.body.classList.add('game-loaded');
        console.log('✅ Preloader hidden, game ready');
      }
    }
    
    // ИСПРАВЛЕНИЕ: Улучшенная обработка ошибок инициализации
    window.addEventListener('error', (event) => {
      console.error('🚨 JavaScript Error:', {
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        error: event.error
      });
      
      // Специальная обработка ошибки appendChild
      if (event.message && 
          event.message.includes('appendChild') && 
          !window.game) {
        
        console.log('🔧 Attempting to fix appendChild error...');
        
        // Очищаем и пересоздаем game контейнер
        const gameDiv = document.getElementById('game');
        if (gameDiv) {
          gameDiv.innerHTML = `
            <div style="
              display: flex; 
              flex-direction: column; 
              justify-content: center; 
              align-items: center; 
              height: 100vh; 
              background: #1d2330; 
              color: #fff; 
              font-family: Arial, sans-serif;
              text-align: center;
              padding: 20px;
            ">
              <h2>🔧 Исправление ошибки...</h2>
              <p>Перезапуск игры через 2 секунды</p>
              <div style="
                width: 30px; 
                height: 30px; 
                border: 2px solid #4ECDC4; 
                border-top: 2px solid transparent; 
                border-radius: 50%; 
                animation: spin 1s linear infinite;
                margin-top: 15px;
              "></div>
            </div>
          `;
          
          // Пытаемся перезапустить игру через 2 секунды
          setTimeout(() => {
            location.reload();
          }, 2000);
        }
      }
      
      // Показываем пользователю ошибку только при критических проблемах
      if (event.message && 
          (event.message.includes('Phaser') || 
           event.message.includes('WebGL') ||
           event.message.includes('dependencies'))) {
        
        const gameDiv = document.getElementById('game');
        if (gameDiv && !window.game) {
          gameDiv.innerHTML = `
            <div style="
              display: flex; 
              flex-direction: column; 
              justify-content: center; 
              align-items: center; 
              height: 100vh; 
              background: #1d2330; 
              color: #fff; 
              font-family: Arial, sans-serif;
              text-align: center;
              padding: 20px;
            ">
              <h2>😔 Ошибка загрузки игры</h2>
              <p>Проверьте подключение к интернету и обновите страницу</p>
              <button onclick="location.reload()" style="
                padding: 12px 24px; 
                font-size: 16px; 
                background: #3498db; 
                color: white; 
                border: none; 
                border-radius: 8px; 
                cursor: pointer;
                margin-top: 20px;
                font-weight: bold;
              ">🔄 Обновить страницу</button>
              <div style="
                margin-top: 20px; 
                font-size: 12px; 
                opacity: 0.7;
                max-width: 400px;
              ">
                Если проблема повторяется, попробуйте открыть игру в другом браузере
              </div>
            </div>
          `;
        }
      }
    });

    // ДОБАВЛЕНО: Оптимизация для мобильных устройств
    if (isMobile) {
      // Предотвращаем масштабирование
      document.addEventListener('touchstart', function(e) {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      }, { passive: false });
      
      // Предотвращаем двойное касание для масштабирования
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function(e) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          e.preventDefault();
        }
        lastTouchEnd = now;
      }, { passive: false });

      // Предотвращаем контекстное меню
      document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
      });

      // Скрываем адресную строку на iOS
      if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        setTimeout(() => {
          window.scrollTo(0, 1);
        }, 100);
      }
      
      console.log('📱 Mobile optimizations applied');
    }

    // ИСПРАВЛЕНИЕ: Улучшенное управление прелоадером
    let gameCheckInterval = setInterval(() => {
      if (window.game && window.game.scene && window.game.scene.scenes.length > 0) {
        hidePreloader();
        clearInterval(gameCheckInterval);
      }
    }, 100);

    // ИСПРАВЛЕНИЕ: Сокращен timeout до 5 секунд для быстрого скрытия
    setTimeout(() => {
      if (document.getElementById('preloader')) {
        console.log('✅ Game loaded, hiding preloader');
        hidePreloader();
      }
      clearInterval(gameCheckInterval);
    }, 5000); // Уменьшено с 10 до 5 секунд
  </script>

  <!-- ИСПРАВЛЕНО: main.js загружается последним с обработкой ошибок -->
  <script src="main.js"></script>
  
  <!-- ДОБАВЛЕНО: Финальные обработчики событий -->
  <script>
    // Обработка поворота экрана
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        if (window.game && window.game.scale) {
          window.game.scale.refresh();
          console.log('🔄 Screen orientation changed, game refreshed');
        }
      }, 500);
    });
    
    // Обработка изменения размера окна
    window.addEventListener('resize', () => {
      if (window.game && window.game.scale) {
        clearTimeout(window.resizeTimeout);
        window.resizeTimeout = setTimeout(() => {
          window.game.scale.refresh();
          console.log('🔄 Window resized, game refreshed');
        }, 250);
      }
    });
    
    // ДОБАВЛЕНО: Очистка при выходе со страницы
    window.addEventListener('beforeunload', () => {
      console.log('🔄 Page unloading, cleaning up...');
      if (window.game) {
        try {
          window.game.destroy(true);
          window.game = null;
        } catch (e) {
          console.warn('Cleanup warning:', e);
        }
      }
    });

    // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Финальная проверка инициализации
    window.addEventListener('load', () => {
      console.log('📄 Page fully loaded');
      
      // Проверяем что игра успешно создалась
      setTimeout(() => {
        if (!window.game) {
          console.warn('⚠️ Game not created after page load - showing error');
          const gameDiv = document.getElementById('game');
          if (gameDiv) {
            gameDiv.innerHTML = `
              <div style="
                display: flex; 
                flex-direction: column; 
                justify-content: center; 
                align-items: center; 
                height: 100vh; 
                background: #1d2330; 
                color: #fff; 
                font-family: Arial, sans-serif;
                text-align: center;
                padding: 20px;
              ">
                <h2>⚠️ Игра не загрузилась</h2>
                <p>Попробуйте обновить страницу или проверьте интернет-соединение</p>
                <button onclick="location.reload()" style="
                  padding: 12px 24px; 
                  font-size: 16px; 
                  background: #e74c3c; 
                  color: white; 
                  border: none; 
                  border-radius: 8px; 
                  cursor: pointer;
                  margin-top: 20px;
                  font-weight: bold;
                ">🔄 Перезагрузить</button>
              </div>
            `;
          }
        }
      }, 3000);
    });
  </script>
  <!-- VK Bridge -->
<script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
<script>
  // Инициализация VK Bridge
  if (window.vkBridge) {
    vkBridge.send('VKWebAppInit');
    window.VK_BRIDGE_READY = true;
  }
</script>

</body>
</html>
